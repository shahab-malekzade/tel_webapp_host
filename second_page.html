<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="format-detection" content="telephone=no"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="MobileOptimized" content="176"/>
  <meta name="HandheldFriendly" content="True"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Hello, world!</title>

  <script src="dist/js/tg_web_app.js"></script>

  <link rel="stylesheet" href="dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="asset/css/second_page.css">

  <script>
		function setThemeClass() {
			document.documentElement.className = Telegram.WebApp.colorScheme;
		}

		Telegram.WebApp.onEvent('themeChanged', setThemeClass);
		setThemeClass();
  </script>

</head>

<body>

<section id="first_page">
  <p class="first-p-title">
    یک اشتراک انتخاب کنید
  </p>
  <h5 class="first-p-desc">
    بهترین پیشنهاد را متناسب با نیاز خود انتخاب کنید
  </h5>

  <div>
    <div class="container" id="scrollContainer">
      <div class="snap-items" id="items">
        <div class="item">
          <div class="card" data-index="0">
            <div class="grid">
              <div class="item-1">
                اشتراک پایه
              </div>
              <div class="item-2">
                !رایگان
              </div>
              <div class="item-3">👶</div>
            </div>
            <hr>
            <p class="features">
              <span class="sticker-features">👍</span>
              <span class="plan-features">
          ۲۵ لایک در روز
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">💬</span>
              <span class="plan-features">
          چت با ناشناس به صورت شانسی
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">👤</span>
              <span class="plan-features">
          پروفایل کاربری
          </span>
            </p>
            <div class="stick-bottom">
              <div class="card-button current-sub">
                <a class="purchase-link" disabled>
                  اشتراک فعلی
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="item">
          <div class="card" data-index="1">
            <div class="grid">
              <div class="item-1">
                اشتراک حرفه ای
              </div>
              <div class="item-2">
                <p style="margin: 0;">
                  <span>۱۰</span>
                  تومان / ماه
                </p>
              </div>
              <div class="item-3">🥈</div>
            </div>
            <hr>
            <p class="features">
              <span class="sticker-features">👍</span>
              <span class="plan-features">
          لایک نامحدود
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">💬</span>
              <span class="plan-features">
          ۱۰۰ چت جدید/ماه
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">👤</span>
              <span class="plan-features">
          ۱۰۰ پیام خصوصی جدید/ماه
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">👀</span>
              <span class="plan-features">
          ببینید چه کسانی شما را لایک میکنند
          </span>
            </p>
            <div class="stick-bottom">
              <div class="card-button">
                <a class="purchase-link" onclick="showSecondPage('professional');">
                  انتخاب
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="item">
          <div class="card" data-index="2">
            <div class="grid">
              <div class="item-1">
                اشتراک پریمیوم
              </div>
              <div class="item-2">
                <p style="margin: 0;">
                  <span>۱۰</span>
                  تومان / ماه
                </p>
              </div>
              <div class="item-3">🥇</div>
            </div>
            <hr>
            <p class="features">
              <span class="sticker-features">👍</span>
              <span class="plan-features">
          لایک نامحدود
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">💬</span>
              <span class="plan-features">
          ۱۰۰ چت جدید/ماه
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">👤</span>
              <span class="plan-features">
          ۱۰۰ پیام خصوصی جدید/ماه
          </span>
            </p>
            <p class="features">
              <span class="sticker-features">👀</span>
              <span class="plan-features">
          ببینید چه کسانی شما را لایک میکنند
          </span>
            </p>
            <div class="stick-bottom">
              <div class="card-button">
                <a class="purchase-link" onclick="showSecondPage('premium');">
                  انتخاب
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="dot-container" id="dotContainer">
      <div class="pill-bg">
        <span class="dot active" data-index="0"></span>
        <span class="dot" data-index="1"></span>
        <span class="dot" data-index="2"></span>
      </div>
    </div>
  </div>

</section>

<section id="second_page">
  <p class="second-p-title">
    <span id="second-p-title">اشتراک پریمیوم</span>
    <span class="sticker-title">🎙️</span>
  </p>

  <h5 class="second-p-desc">
    قفل دنیایی از چت های خارق العاده را باز کنید، داستان شما از اینجا شروع می شود.
  </h5>

  <div class="plans">
    <div id="box-1" class="card card-second-page">

      <div id="triangle-1" class="triangle">
        <div style="padding: 5px;"><span>⭐</span></div>
      </div>

      <div class="grid-2">
        <div class="price">
          <p style="font-size: 10px;">
            <span style="font-size: 16px;">۹۶</span>
            تومان / ماه
          </p>
        </div>
        <div class="interval-txt">
          سالیانه
          <p class="card-desc">
            برای یک سال کامل پرداخت کنید
          </p>
        </div>
        <div class="radio-btn">
          <div class="outer-circle">
            <div id="inner-circle-1" class="inner-circle"></div>
          </div>
        </div>
      </div>

      <hr style="margin-bottom: 10px;">

      <p class="features">
        <span class="sticker-features">💰</span>
        <span class="plan-features-2">
        با خرید اشتراک سالانه از تخفیف ویژه برخوردار شوید
      </span>
      </p>
      <p class="features">
        <span class="sticker-features">🌟</span>
        <span class="plan-features-2">
        امتیازات منحصر به فرد مشترکین سالانه را آزاد کنید
      </span>
      </p>
      <p class="features">
        <span class="sticker-features">🛡️</span>
        <span class="plan-features-2">
        سالی را بدون افزایش قیمت غیر منتظره تجربه کنید
      </span>
      </p>
    </div>

    <!--    <div style="height: 15px;"></div>-->
    <!--  </div>-->
    <!--  <div>-->
    <div id="box-2" class="card card-second-page">

      <div class="grid-2">
        <div class="price">
          <p style="font-size: 10px;">
            <span style="font-size: 16px;">۱۲۰</span>
            تومان / ماه
          </p>
        </div>
        <div class="interval-txt">
          ماهیانه
          <p class="card-desc">
            به صورت ماهانه پرداخت کنید
          </p>
        </div>
        <div class="radio-btn">
          <div class="outer-circle">
            <div id="inner-circle-2" class="inner-circle"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<section id="third_page">
  <h2 class="landscape-msg">
    لطفا صفحه گوشی خود را به حالت عمودی برگردانید
  </h2>
</section>

<!-- Option 1: Bootstrap Bundle with Popper -->
<script src="dist/js/bootstrap.bundle.min.js"></script>
<script type="application/javascript">
	Telegram.WebApp.ready();

	let subscription = null;
	let interval = null;

	let first_page = document.getElementById("first_page");
	let second_page = document.getElementById("second_page");
	let third_page = document.getElementById("third_page");
	let triangle_1 = document.getElementById("triangle-1");

	let landscape = window.matchMedia("(orientation: landscape)");

	// function expandMode(func) {
	// 	var timer;
	// 	return function (event) {
	// 		if (timer) clearTimeout(timer);
	// 		timer = setTimeout(func, 100, event);
	// 	};
	// }

	// // Telegram.WebApp.sendData(`hi shahab ${Telegram.WebApp.isExpanded}`);
	// window.addEventListener("resize", expandMode(function (e) {
	// 	// Make the content place in the center of screen when Telegram.WebApp.isExpanded
	// 	const newHeight = window.innerHeight ||
	// 			document.documentElement.clientHeight ||
	// 			document.body.clientHeight;
	// 	if (newHeight > 600) {
	// 		document.body.style.height = `${newHeight - 50}px`;
	// 		document.documentElement.style.setProperty('--tg-viewport-height', `${window.Telegram.WebApp.viewportHeight}px`);
	// 	} else {
	// 		document.body.style.height = null;
	// 	}
	// }));

	landscape.addEventListener("change", function (e) {
		if (e.matches) {
			landscapeMode();
		} else {
			portraitMode();
		}
	});

	if (window.matchMedia("(orientation: landscape)").matches) {
		landscapeMode();
	} else {
		portraitMode();
	}

	function showMainButton() {
		Telegram.WebApp.MainButton
			.setText(
				'خرید اشتراک'
			)
			.show()
			.onClick(function () {
				console.log(`subscription/interval : ${subscription} - ${interval}`);
				Telegram.WebApp.openLink('https://google.com', {try_instant_view: true}
				);
			});
	}

	function showSecondPage(plan) {
		first_page.style.display = "none";
		second_page.style.display = "block";
		third_page.style.display = "none";

		const box1 = document.getElementById('box-1');
		const box2 = document.getElementById('box-2');

		const circle1 = document.getElementById('inner-circle-1');
		const circle2 = document.getElementById('inner-circle-2');

		if (plan === 'professional') {
			document.getElementById('second-p-title').innerHTML = 'اشتراک حرفه ای';
			subscription = 'professional';
		} else if (plan === 'premium') {
			document.getElementById('second-p-title').innerHTML = 'اشتراک پریمیوم';
			subscription = 'premium';
		}

		selectDefaultInterval();

		box1.addEventListener('click', () => {
			selectDefaultInterval();
		});

		box2.addEventListener('click', () => {
			box2.classList.add('selected');
			box1.classList.remove('selected');
			circle2.classList.add('selected');
			circle1.classList.remove('selected');
			interval = 'monthly';
			triangle_1.style.display = "none";
			showMainButton();
		});

		Telegram.WebApp.BackButton
			.show()
			.onClick(function () {
				second_page.style.display = "none";
				first_page.style.display = "block";
				Telegram.WebApp.BackButton.hide();
				Telegram.WebApp.MainButton.hide();
				box1.classList.remove('selected');
				box2.classList.remove('selected');
				circle1.classList.remove('selected');
				circle2.classList.remove('selected');
				triangle_1.style.display = "none";
				subscription = null;
				interval = null;
			});

		function selectDefaultInterval() {
			box1.classList.add('selected');
			box2.classList.remove('selected');
			circle1.classList.add('selected');
			circle2.classList.remove('selected');
			interval = 'yearly';
			triangle_1.style.display = "block";
			showMainButton();
		}
	}

	function showFirstPage() {
		const box1 = document.getElementById('box-1');
		const box2 = document.getElementById('box-2');

		const circle1 = document.getElementById('inner-circle-1');
		const circle2 = document.getElementById('inner-circle-2');
		second_page.style.display = "none";
		first_page.style.display = "block";
		third_page.style.display = "none";
		Telegram.WebApp.BackButton.hide();
		Telegram.WebApp.MainButton.hide();
		box1.classList.remove('selected');
		box2.classList.remove('selected');
		circle1.classList.remove('selected');
		circle2.classList.remove('selected');
		subscription = null;
		interval = null;

	}

	function portraitMode() {
		first_page.style.display = "block";
		second_page.style.display = "none";
		// first_page.style.display = "none";
		// second_page.style.display = "flex";
		third_page.style.display = "none";
		triangle_1.style.display = "none";
		Telegram.WebApp.bg_color = 'FF0000';

		let container = document.getElementById('scrollContainer');
		let dots = document.querySelectorAll('.dot');
		let cards = document.querySelectorAll('.card');

		function scrollToIndex(index) {
			let width = cards.item(0).clientWidth;
			let scrollPosition = index * width;

			container.scrollTo({
				left: scrollPosition,
				behavior: 'smooth'
			});
		}

		let scrollAmount = cards.item(0).clientWidth;
		let scrollLeft = container.scrollLeft;
		let index = Math.floor((scrollLeft) / scrollAmount);

		if (window.Telegram && window.Telegram.WebApp) {
			document.documentElement.style.setProperty('--tg-viewport-height', `${window.Telegram.WebApp.viewportHeight}px`);
			window.Telegram.WebApp.onEvent('viewportChanged', function (data) {
				if (data && data.isStateStable) {
					document.documentElement.style.setProperty('--tg-viewport-height', `${data.viewportHeight}px`);
					if (Telegram.WebApp.isExpanded) {
						if (first_page.style.display === 'block') {
							first_page.style.display = "flex";
						} else if (second_page.style.display === 'block') {
							second_page.style.display = "flex";
						}
					} else {
						if (first_page.style.display === 'flex') {
							first_page.style.display = "block";
						} else if (second_page.style.display === 'flex') {
							second_page.style.display = "block";
						}
					}
				}
			});
		}

		const items = document.getElementById('items');
		const card = document.querySelector('.item');
		let card_width = card.offsetWidth;
		let container_width = container.offsetWidth;
		items.style.transform = `translateX(${0.10 * container_width}px)`;

		let isDragging = false;
		let startPos = 0;
		let startY = 0;
		let currentTranslate = 0;
		let previousTranslate = 0;
		let animationId = 0;
		let currentIndex = 0;
		let hasMoved = false;

		container.addEventListener('mousedown', start);
		container.addEventListener('mouseup', end);
		container.addEventListener('mousemove', move);

		container.addEventListener('touchstart', start);
		container.addEventListener('touchend', end);
		container.addEventListener('touchmove', move);

		function start(event) {
			isDragging = true;
			startPos = getPositionX(event);
			startY = getPositionY(event);
			previousTranslate = currentTranslate;

			// Cancel ongoing animations while dragging
			cancelAnimationFrame(animationId);

			// Remove transition to move instantly
			items.style.transition = 'none';
		}

		const threshold = 10;
		let horizontalMove = 0;
		const slopeThreshold = 0.5;

		function move(event) {

			if (!hasMoved) {
				items.style.transition = 'none';
				hasMoved = true;
			}
			if (isDragging) {
				// console.log({event})
				const currentPosX = getPositionX(event);
				const currentPosY = getPositionY(event);
				horizontalMove += Math.abs(currentPosX - startPos);
				if (horizontalMove < threshold) {
					const xDiff = currentPosX - startPos;
					const yDiff = currentPosY - startY; // you'll need startY
					const slope = Math.abs(yDiff / xDiff);
					if (slope < slopeThreshold) {
						// mostly horizontal, prevent vertical
						event.preventDefault();
					}
				}
				const direction = currentPosX - startPos;
				if (currentIndex === 0 && direction > 0) {
					currentTranslate = previousTranslate + (currentPosX - startPos) / 3;
				} else if (currentIndex === 2 && direction < 0) {
					currentTranslate = previousTranslate + (currentPosX - startPos) / 3;
				} else {
					currentTranslate = previousTranslate + (currentPosX - startPos);
				}
				setTransform(currentTranslate);
			}
		}

		function end() {
			isDragging = false;

			const movedBy = currentTranslate - previousTranslate;

			// Add transition back
			items.style.transition = 'transform 0.3s';

			// If moved a significant amount
			if (movedBy < -5 && currentIndex < 2) {
				currentIndex += 1;
			} else if (movedBy > 5 && currentIndex > 0) {
				currentIndex -= 1;
			}

			setPositionByIndex();

			previousTranslate = currentTranslate;
		}

		function getPositionX(event) {
			return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
		}

		function getPositionY(event) {
			return event.type.includes('mouse') ? event.pageY : event.touches[0].clientY;
		}

		function setPositionByIndex() {

			if (currentIndex === 0) {
				currentTranslate = 0.09 * container_width;
			} else if (currentIndex === 1) {
				currentTranslate = (0.09 * container_width) + currentIndex * -card_width;
			} else {
				currentTranslate = (0.09 * container_width) + currentIndex * -card_width;
			}
			setTransform(currentTranslate);
		}

		function setTransform(value) {
			items.style.transform = `translateX(${value}px)`;
		}


		container.addEventListener('scroll', function () {
			scrollLeft = container.scrollLeft;
			index = Math.floor((scrollLeft) / scrollAmount);

			dots.forEach(function (dot, i) {
				if (i === index) {
					dot.classList.add('active');
				} else {
					dot.classList.remove('active');
				}
			});
		});

		dots.forEach(function (dot, i) {
			dot.addEventListener('click', function () {
				let index = dot.getAttribute('data-index');
				scrollToIndex(index);
			});
		});

		cards.forEach(function (card, i) {
			card.addEventListener('click', function () {
				let index = card.getAttribute('data-index');
				scrollToIndex(index);
			});
		});
	}

	function landscapeMode() {
		first_page.style.display = "none";
		second_page.style.display = "none";
		third_page.style.display = "block";
	}

</script>
</body>
</html>